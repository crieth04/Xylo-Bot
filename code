#include <Wire.h>
#include <Adafruit_PWMServoDriver.h>
#include <IRremote.h> 
#include <LiquidCrystal_I2C.h> 

// --- HARDWARE SETUP ---
LiquidCrystal_I2C lcd(0x27, 16, 2); // Try 0x3F if screen is blank
Adafruit_PWMServoDriver pwm = Adafruit_PWMServoDriver(0x40);

// Pins
const int IR_RECV_PIN = 11;
// Buzzer removed
const int RED_PIN = 6;  
const int GRN_PIN = 5;  
const int BLU_PIN = 3; 

// Servos
int SERVO_COUNT_ACTIVE = 8;
uint16_t restUs_all[8]   = {1400,1500,1550,1500,1550,1500,1400,1400};
uint16_t strikeUs_all[8] = {1300,1325,1250,1300,1375,1300,1125,1150};

// Timings
const int STRIKE_DWELL_MS = 45;
const int SONG_NOTE_DWELL_MS = 50;
const int SONG_NOTE_RETURN_MS = 50;

// Variables
unsigned long servoReturnTime[8]; 
bool isServoStriking[8];
unsigned long ledOffTime = 0; 

// Menu Variables
int currentMenuIndex = 0;
const int TOTAL_SONGS = 5;
String songNames[] = {
  "1. Twinkle", 
  "2. Mary Lamb", 
  "3. Jingle Bell", 
  "4. Birthday", 
  "5. Row Boat"
};

// Note Colors (R, G, B)
const byte noteColors[8][3] = {
  {255, 0, 0},    // 0: Red
  {255, 40, 0},   // 1: Orange
  {255, 180, 0},  // 2: Yellow
  {130, 255, 0},  // 3: Lt Green
  {0, 150, 0},    // 4: Dk Green
  {0, 255, 255},  // 5: Lt Blue
  {0, 0, 255},    // 6: Dk Blue
  {200, 0, 255}   // 7: Purple
};

// --- HELPER FUNCTIONS ---

void setLED(int r, int g, int b) {
  analogWrite(RED_PIN, r);
  analogWrite(GRN_PIN, g);
  analogWrite(BLU_PIN, b);
}

void ledOff() {
  setLED(0, 0, 0);
}

void updateMenuLCD() {
  lcd.clear();
  lcd.setCursor(0, 0); 
  lcd.print("Select Song <>OK");
  lcd.setCursor(0, 1);
  lcd.print(songNames[currentMenuIndex]);
}

void printStatus(String line1, String line2) {
  lcd.clear();
  lcd.setCursor(0, 0); lcd.print(line1);
  lcd.setCursor(0, 1); lcd.print(line2);
}

// --- PLAY FUNCTIONS ---

void playNote(uint8_t ch) {
  if (ch >= SERVO_COUNT_ACTIVE) return;
  setLED(noteColors[ch][0], noteColors[ch][1], noteColors[ch][2]); // Color ON
  pwm.writeMicroseconds(ch, strikeUs_all[ch]);
  delay(SONG_NOTE_DWELL_MS);
  pwm.writeMicroseconds(ch, restUs_all[ch]);
  ledOff(); // Color OFF
  delay(SONG_NOTE_RETURN_MS);
}

void strike(uint8_t ch) {
  if (ch >= SERVO_COUNT_ACTIVE) return;
  if (!isServoStriking[ch]) {
    setLED(noteColors[ch][0], noteColors[ch][1], noteColors[ch][2]); // Color ON
    ledOffTime = millis() + 150; // Keep LED on briefly
    pwm.writeMicroseconds(ch, strikeUs_all[ch]);
    isServoStriking[ch] = true;
    servoReturnTime[ch] = millis() + STRIKE_DWELL_MS;
  }
}

// --- SONGS ---

void play_twinkle() {
  printStatus("Playing:", "Twinkle Twinkle");
  int tempo = 300; 
  int notes[] = {0, 0, 4, 4, 5, 5, 4, -1, 3, 3, 2, 2, 1, 1, 0};
  for(int x : notes) { if(x==-1) delay(tempo); else { playNote(x); delay(tempo-100); }}
  updateMenuLCD();
}
void play_mary() {
  printStatus("Playing:", "Mary Had a Lamb");
  int tempo = 250; 
  int notes[] = {2, 1, 0, 1, 2, 2, 2, -1, 1, 1, 1, -1, 2, 4, 4, -1};
  for(int x : notes) { if(x==-1) delay(tempo); else { playNote(x); delay(tempo-100); }}
  updateMenuLCD();
}
void play_jingle() {
  printStatus("Playing:", "Jingle Bells");
  int tempo = 250; 
  int notes[] = {2, 2, 2, -1, 2, 2, 2, -1, 2, 4, 0, 1, 2, -1, -1};
  for(int x : notes) { if(x==-1) delay(tempo); else { playNote(x); delay(tempo-100); }}
  updateMenuLCD();
}
void play_happy_birthday() {
  printStatus("Playing:", "Happy Birthday");
  int tempo = 350; 
  int notes[] = {0, 0, 1, 0, 3, 2, -1, 0, 0, 1, 0, 4, 3, -1};
  for(int x : notes) { if(x==-1) delay(tempo); else { playNote(x); delay(tempo-100); }}
  updateMenuLCD();
}
void play_row_boat() {
  printStatus("Playing:", "Row Your Boat");
  int tempo = 300; 
  int notes[] = {0, 0, 0, 1, 2, -1, 2, 1, 2, 3, 4};
  for(int x : notes) { if(x==-1) delay(tempo); else { playNote(x); delay(tempo-100); }}
  updateMenuLCD();
}


void setup() {
  Serial.begin(115200);
  Wire.begin();
  
  lcd.init(); lcd.backlight();
  
  pinMode(RED_PIN, OUTPUT); pinMode(GRN_PIN, OUTPUT); pinMode(BLU_PIN, OUTPUT);
  // Buzzer init removed
  
  pwm.begin(); pwm.setPWMFreq(60);
  IrReceiver.begin(IR_RECV_PIN, DISABLE_LED_FEEDBACK);

  // Boot sequence
  printStatus("Xylo-Bot 3000", "Booting...");
  delay(1000);
  
  // Servos to rest
  for (int ch = 0; ch < SERVO_COUNT_ACTIVE; ch++) {
    pwm.writeMicroseconds(ch, restUs_all[ch]);
    isServoStriking[ch] = false; servoReturnTime[ch] = 0;
    delay(50);
  }
  
  updateMenuLCD();
}

void loop() {
  unsigned long now = millis();

  // 1. Servo Return Logic
  for (int i = 0; i < SERVO_COUNT_ACTIVE; i++) {
    if (isServoStriking[i] && now >= servoReturnTime[i]) {
      pwm.writeMicroseconds(i, restUs_all[i]);
      isServoStriking[i] = false; 
    }
  }
  
  // 2. LED Auto-Off
  if (now > ledOffTime && ledOffTime > 0) {
    ledOff();
    ledOffTime = 0;
  }

  // 3. IR Remote Logic
  if (IrReceiver.decode()) {
    
    // DEBUG: Print the code to Serial Monitor so you can find RIGHT and OK
    Serial.print("Code: 0x");
    Serial.println(IrReceiver.decodedIRData.decodedRawData, HEX);

    switch (IrReceiver.decodedIRData.decodedRawData) {
      
      // --- MANUAL NOTES (Your Codes) ---
      case 0xE916FF00: strike(0); break; // 1
      case 0xE619FF00: strike(1); break; // 2
      case 0xF20DFF00: strike(2); break; // 3
      case 0xF30CFF00: strike(3); break; // 4
      case 0xE718FF00: strike(4); break; // 5
      case 0xA15EFF00: strike(5); break; // 6
      case 0xF708FF00: strike(6); break; // 7
      case 0xE31CFF00: strike(7); break; // 8

      // --- MENU NAVIGATION ---
      
      // LEFT Arrow (Using your code)
      case 0xBB44FF00: 
        currentMenuIndex--;
        if (currentMenuIndex < 0) currentMenuIndex = TOTAL_SONGS - 1; // Loop to end
        updateMenuLCD();
        break;

      // RIGHT Arrow (REPLACE THIS CODE)
      case 0xBC43FF00: // <--- FIND THIS CODE IN SERIAL MONITOR
        currentMenuIndex++;
        if (currentMenuIndex >= TOTAL_SONGS) currentMenuIndex = 0; // Loop to start
        updateMenuLCD();
        break;

      // OK Button (REPLACE THIS CODE)
      case 0xBF40FF00:    // <--- FIND THIS CODE IN SERIAL MONITOR
        Serial.println("Playing Song...");
        if(currentMenuIndex == 0) play_twinkle();
        else if(currentMenuIndex == 1) play_mary();
        else if(currentMenuIndex == 2) play_jingle();
        else if(currentMenuIndex == 3) play_happy_birthday();
        else if(currentMenuIndex == 4) play_row_boat();
        break;

      case 0xFFFFFFFF: break; // Repeat code
      default: break;
    }
    IrReceiver.resume(); 
  }
}
